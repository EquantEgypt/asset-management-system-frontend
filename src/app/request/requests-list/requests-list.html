<div class="requests-container">
    <div class="top-container">
        @if(role === 'EMPLOYEE') {
        <h2>My Requests</h2>

        }@else if(role === 'ADMIN') {        <h2>All Requests</h2>
}@else{
        <h2>Maintenance Requests</h2>

        }
        <div class="filters">
            <mat-form-field appearance="outline" class="search-field">
                <mat-label>Search</mat-label>
                <input matInput (input)="searchBar(searchInput.value)" #searchInput>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Request Status</mat-label>
                <mat-select [(value)]="selectedStatus" (selectionChange)="loadRequests()">
                    <mat-option [value]="''">All Status</mat-option>
                    <mat-option value="APPROVED">APPROVED</mat-option>
                    <mat-option value="REJECTED">REJECTED</mat-option>
                    <mat-option value="PENDING">PENDING</mat-option>
                </mat-select>
            </mat-form-field>

            @if(role === 'ADMIN') {
            <mat-form-field appearance="outline">
                <mat-label>Request Type</mat-label>
                <mat-select [(value)]="selectedType" (selectionChange)="loadRequests()">
                    <mat-option [value]="''">All Types</mat-option>
                    <mat-option value="NEW">NEW</mat-option>
                    <mat-option value="MAINTENANCE">MAINTENANCE</mat-option>
                </mat-select>
            </mat-form-field>
            }
        </div>
    </div>

    <div *ngIf="isLoading" class="loading-spinner">
        <mat-spinner diameter="40"></mat-spinner>
    </div>
    <div *ngIf="!isLoading && requests.length === 0" class="no-requests">
        <p>No requests found.</p>
    </div>

    <table mat-table [dataSource]="requests" class="mat-elevation-z4 requests-table"
        *ngIf="!isLoading && requests.length > 0">
        <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let request">{{ request.id }}</td>
        </ng-container>

        <ng-container matColumnDef="requester">
            <th mat-header-cell *matHeaderCellDef>Requester</th>
            <td mat-cell *matCellDef="let request">{{ request.requester }}</td>
        </ng-container>

        <ng-container matColumnDef="requestType">
            <th mat-header-cell *matHeaderCellDef>Request Type</th>
            <td mat-cell *matCellDef="let request">{{ request.requestType }}</td>
        </ng-container>

        <!-- <ng-container matColumnDef="assetName">
            <th mat-header-cell *matHeaderCellDef>Asset Name</th>
            <td mat-cell *matCellDef="let request">{{ request.assetName|| 'N/A' }}</td>
        </ng-container> -->

        <ng-container matColumnDef="assetType">
            <th mat-header-cell *matHeaderCellDef>Asset Type</th>
            <td mat-cell *matCellDef="let request">{{ request.assetTypeName || 'N/A' }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let request">
                <span class="status-badge" [ngClass]="request.status.toLowerCase()">
                    {{ request.status }}
                </span>
            </td>
        </ng-container>

        <ng-container matColumnDef="requestDate">
            <th mat-header-cell *matHeaderCellDef>Request Date</th>
            <td mat-cell *matCellDef="let request">{{ request.requestDate | date: 'medium' }}</td>
        </ng-container>
        <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef>Action</th>
            <td mat-cell *matCellDef="let request">
                <div class="action-buttons" *ngIf="request.status === 'PENDING'">
                    @if(role === 'ADMIN' && request.requestType === 'MAINTENANCE') {
                    <div class="waiting-approval">
                        <span class="waiting-text">Waiting for IT approval</span>
                    </div>
                    }@else if (role === 'EMPLOYEE'){
                    <p>Waiting for a Response</p>
                    } @else {
                    <button class="reject-btn" (click)="openRejectModalSimple(request)">
                        REJECT
                    </button>

                    <button class="approve-btn" (click)="updateStatus(request, 'APPROVED')">
                                            @if(request.requestType === 'MAINTENANCE') {
                                                                 send to Maintenance

                                            }@else{
Approve
                                            }
                                             
                    </button>

                    }
                </div>

                <div class="resolved-status" *ngIf="request.status === 'APPROVED'">
                    <span class="resolved-text">✓ Resolved</span>
                </div>

                <div class="rejected-status" *ngIf="request.status === 'REJECTED'">
                    <span class="rejected-text">✗ Rejected</span>
                </div>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator [length]="totalElements" [pageSize]="pageSize" [pageSizeOptions]="[5, 10, 20]"
        (page)="handlePageEvent($event)">
    </mat-paginator>

</div>
<div *ngIf="showAssignModal && dataToAssign" class="modal-overlay">
    <div class="modal-content">
        <div (click)="showAssignModal = false; dataToAssign = null" class="close-modal-btn">
            <i class="fa-solid fa-xmark"></i>
        </div>
        <app-assign-asset-form [receivedData]="dataToAssign" (closeModal)="handleClose($event)">
        </app-assign-asset-form>

    </div>
</div>
<div class="modal-overlay" *ngIf="showRejectModal" (click)="closeRejectModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Confirm Rejection</h3>
            <button class="close-btn" (click)="closeRejectModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to reject this request?</p>
            <div class="warning">
                <strong>Warning:</strong> This action cannot be undone.
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel-btn" (click)="closeRejectModal()">Cancel</button>
            <button class="confirm-btn" (click)="confirmRejectSimple()">Yes, Reject</button>
        </div>
    </div>
</div>